# -*- coding: utf-8 -*-
"""streamlit_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1M0gY5vmJM_Od6sB1JYtAb_ZEl99MF4uz
"""

import joblib
import pandas as pd
import numpy as np
import shap
import seaborn as sns
import matplotlib.pyplot as plt
import streamlit as st
import plotly.graph_objects as go

# -----------------------------------------------------------
# PAGE CONFIG
# -----------------------------------------------------------
st.set_page_config(
    page_title="Credit Risk Prediction",
    page_icon="üí≥",
    layout="wide"
)

st.markdown("""
<style>
/* Make the app clean & light */
.stApp {
    background-color: #f7f9fc !important;
}

/* White cards */
.block {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    margin-bottom: 18px;
}

/* Buttons */
.stButton>button {
    width: 100%;
    border-radius: 8px;
    background-color: #2563eb !important;
    color: white !important;
    height: 3em;
    font-size: 1.05em;
    border: none;
}

/* Fix input text colors */
input, select, textarea {
    color: #1f2937 !important;
}

</style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------
# LOAD MODELS
# -----------------------------------------------------------
@st.cache_resource
def load_objects():
    model = joblib.load("xgboost_credit_model.pkl")
    scaler = joblib.load("scaler.pkl")
    explainer = shap.TreeExplainer(model)
    return model, scaler, explainer

model, scaler, explainer = load_objects()
SCALER_COLS = scaler.feature_names_in_

# -----------------------------------------------------------
# FEATURE LABELS (make SHAP readable)
# -----------------------------------------------------------
FEATURE_LABELS = {
    "person_age": "Age",
    "person_income": "Income",
    "person_emp_length": "Employment Length",
    "loan_grade": "Loan Grade",
    "loan_amnt": "Loan Amount",
    "loan_int_rate": "Interest Rate",
    "loan_percent_income": "Loan % Income (DTI)",
    "cb_person_default_on_file": "Previous Default",
    "cb_person_cred_hist_length": "Credit History Length"
}

def rename_features(series):
    return series.rename(lambda x: FEATURE_LABELS.get(x, x))

# -----------------------------------------------------------
# PREPROCESS
# -----------------------------------------------------------
def preprocess(df_raw):
    df = df_raw.copy()

    df["cb_person_default_on_file"] = df["cb_person_default_on_file"].map({"Y": 1, "N": 0})

    grade_map = {"A": 1, "B": 2, "C": 3, "D": 4, "E": 5, "F": 6, "G": 7}
    df["loan_grade"] = df["loan_grade"].map(grade_map)

    df = pd.get_dummies(df)
    model_features = model.get_booster().feature_names

    for col in model_features:
        if col not in df:
            df[col] = 0

    df = df[model_features]
    df[SCALER_COLS] = scaler.transform(df[SCALER_COLS])

    return df

# -----------------------------------------------------------
# GAUGE CHART
# -----------------------------------------------------------
def gauge(prob):
    value = int(prob * 100)
    fig = go.Figure(go.Indicator(
        mode="gauge+number",
        value=value,
        number={"suffix": "%"},
        gauge={
            "axis": {"range": [0, 100]},
            "steps": [
                {"range": [0, 15], "color": "#c7f9cc"},
                {"range": [15, 35], "color": "#fef9c3"},
                {"range": [35, 100], "color": "#fecaca"}
            ],
            "bar": {"color": "#2563eb"}
        }
    ))
    fig.update_layout(height=250, margin=dict(t=20, b=20))
    return fig

# -----------------------------------------------------------
# SIDEBAR
# -----------------------------------------------------------
st.sidebar.title("‚ÑπÔ∏è About this App")
st.sidebar.write("""
This app predicts the probability that a loan applicant will **default** using XGBoost.

### Includes:
- Preprocessing  
- Single prediction  
- Batch CSV scoring  
- SHAP explanations  
- Seaborn importance visuals  
""")

# -----------------------------------------------------------
# MAIN HEADER
# -----------------------------------------------------------
st.title("üí≥ Credit Risk Prediction (XGBoost)")
st.write("Fill the form below or upload a CSV to evaluate multiple clients.")

# -----------------------------------------------------------
# TABS
# -----------------------------------------------------------
tab1, tab2 = st.tabs(["üîç Single Prediction", "üìÇ Batch Prediction"])

# ===========================================================
# SINGLE PREDICTION
# ===========================================================
with tab1:

    with st.form("single_form"):

        col1, col2 = st.columns(2)

        # ---------- CLIENT INFO ----------
        with col1:
            st.markdown("<div class='block'><h3>üë§ Client Information</h3>", unsafe_allow_html=True)

            age = st.number_input("Age", 18, 100, 30)
            income = st.number_input("Annual Income ($)", 0, 5000000, 50000)
            emp = st.number_input("Employment Length (years)", 0, 50, 5)
            cred = st.number_input("Credit History Length (years)", 0, 50, 10)
            home = st.selectbox("Home Ownership", ["RENT", "OWN", "MORTGAGE", "OTHER"])
            prev = st.selectbox("Has Defaulted Before?", ["N", "Y"])

            st.markdown("</div>", unsafe_allow_html=True)

        # ---------- LOAN INFO ----------
        with col2:
            st.markdown("<div class='block'><h3>üí∞ Loan Information</h3>", unsafe_allow_html=True)

            intent = st.selectbox("Loan Intent", ["PERSONAL", "EDUCATION", "MEDICAL", "VENTURE", "HOMEIMPROVEMENT", "DEBTCONSOLIDATION"])
            grade = st.selectbox("Loan Grade", ["A", "B", "C", "D", "E", "F", "G"])
            amount = st.number_input("Loan Amount ($)", 500, 50000, 10000)
            rate = st.number_input("Interest Rate (%)", 0.0, 40.0, 10.0)
            pct = st.number_input("Loan Percent Income (DTI)", 0.0, 1.0, 0.20)

            st.markdown("</div>", unsafe_allow_html=True)

        submitted = st.form_submit_button("üîé Predict Risk")

    if submitted:
        raw = pd.DataFrame([{
            "person_age": age,
            "person_income": income,
            "person_emp_length": emp,
            "cb_person_cred_hist_length": cred,
            "person_home_ownership": home,
            "cb_person_default_on_file": prev,
            "loan_intent": intent,
            "loan_grade": grade,
            "loan_amnt": amount,
            "loan_int_rate": rate,
            "loan_percent_income": pct
        }])

        X = preprocess(raw)
        prob = model.predict_proba(X)[0, 1]

        if prob < 0.15:
            risk = "üü¢ Low Risk"
        elif prob < 0.35:
            risk = "üü° Medium Risk"
        else:
            risk = "üî¥ High Risk"

        # ---------- SHOW RESULT ----------
        st.markdown("<div class='block'>", unsafe_allow_html=True)
        st.subheader("Prediction Result")

        colA, colB = st.columns([1, 1.2])
        with colA:
            st.write(f"### Default Probability: **{prob*100:.2f}%**")
            st.write(f"### Risk Level: **{risk}**")

        with colB:
            st.plotly_chart(gauge(prob), use_container_width=True)

        st.markdown("</div>", unsafe_allow_html=True)

        # ---------- SHAP VISUAL ----------
        st.markdown("<div class='block'>", unsafe_allow_html=True)
        st.subheader("SHAP Explanation")

        shap_values = explainer.shap_values(X)
        if isinstance(shap_values, list):
            shap_row = shap_values[1][0]
        else:
            shap_row = shap_values[0]

        contrib = pd.Series(shap_row, index=X.columns).abs().sort_values(ascending=False).head(8)
        contrib = rename_features(contrib)

        # Seaborn Plot
        plt.figure(figsize=(7, 4))
        sns.barplot(x=contrib.values, y=contrib.index, palette="Blues_d")
        plt.title("Top Features Influencing Prediction")
        plt.xlabel("SHAP Value")
        st.pyplot(plt)

        st.markdown("</div>", unsafe_allow_html=True)

# ===========================================================
# BATCH PREDICTION
# ===========================================================
with tab2:

    st.markdown("<div class='block'><h3>üìÇ Batch CSV Prediction</h3>", unsafe_allow_html=True)

    uploaded = st.file_uploader("Upload a CSV file", type=["csv"])

    if uploaded:
        df_input = pd.read_csv(uploaded)
        st.write("Preview:", df_input.head())

        X_batch = preprocess(df_input)
        probs = model.predict_proba(X_batch)[:, 1]

        df_input["default_probability"] = probs
        df_input["risk"] = pd.cut(
            probs,
            bins=[0, 0.15, 0.35, 1.0],
            labels=["Low", "Medium", "High"]
        )

        st.write("üìä Results:", df_input)

        st.download_button(
            "‚¨áÔ∏è Download Results CSV",
            df_input.to_csv(index=False).encode("utf-8"),
            "batch_predictions.csv",
            "text/csv"
        )
