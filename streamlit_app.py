# -*- coding: utf-8 -*-
"""streamlit_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1M0gY5vmJM_Od6sB1JYtAb_ZEl99MF4uz
"""

    
import streamlit as st
import numpy as np
import pandas as pd
import joblib
import shap
import matplotlib.pyplot as plt
import seaborn as sns

# ----------------------------
# Load model & preprocessing
# ----------------------------
model = joblib.load("xgboost_credit_model.pkl")
scaler = joblib.load("scaler.pkl")

# ----------------------------
# Pretty Feature Names for SHAP
# ----------------------------
def prettify_feature_name(name):
    mapping = {
        "person_age": "Age",
        "person_income": "Income",
        "person_emp_length": "Employment Length (yrs)",
        "cb_person_cred_hist_length": "Credit History Length (yrs)",
        "loan_grade": "Loan Grade",
        "loan_amnt": "Loan Amount",
        "loan_int_rate": "Interest Rate",
        "loan_percent_income": "Loan % Income (DTI)",
        "cb_person_default_on_file": "Previous Default",
    }

    if name in mapping:
        return mapping[name]

    if name.startswith("person_home_ownership_"):
        return "Home Ownership: " + name.split("_")[-1]

    if name.startswith("loan_intent_"):
        return "Loan Intent: " + name.split("_")[-1]

    return name


# ------------------------------------
# Streamlit Setup
# ------------------------------------
st.set_page_config(page_title="Credit Risk Prediction", layout="wide")

st.title("ðŸ’³ Credit Risk Prediction App")
st.write("Enter client and loan details to predict default probability.")


# ------------------------------------
# User Input Form
# ------------------------------------
col1, col2 = st.columns(2)

with col1:
    st.subheader("Client Information")

    age = st.number_input("Age", 18, 100, 30)
    income = st.number_input("Annual Income ($)", 1000, 500000, 50000)
    emp_length = st.number_input("Employment Length (years)", 0, 60, 5)
    cred_length = st.number_input("Credit History Length (years)", 0, 40, 10)

    home_ownership = st.selectbox(
        "Home Ownership", ["RENT", "OWN", "MORTGAGE", "OTHER"]
    )
    default_before = st.selectbox("Has Defaulted Before?", ["Y", "N"])

with col2:
    st.subheader("Loan Information")

    loan_intent = st.selectbox(
        "Loan Intent",
        [
            "PERSONAL",
            "EDUCATION",
            "MEDICAL",
            "VENTURE",
            "HOMEIMPROVEMENT",
            "DEBTCONSOLIDATION",
        ],
    )

    loan_grade = st.selectbox("Loan Grade", ["A", "B", "C", "D", "E", "F", "G"])
    loan_amnt = st.number_input("Loan Amount ($)", 500, 50000, 10000)
    interest_rate = st.number_input("Interest Rate (%)", 1.0, 40.0, 10.0)
    dti = st.number_input("Loan % Income (DTI)", 0.01, 1.0, 0.20)


# ------------------------------------
# Build Input Row
# ------------------------------------
input_dict = {
    "person_age": age,
    "person_income": income,
    "person_emp_length": emp_length,
    "cb_person_cred_hist_length": cred_length,
    "loan_grade": loan_grade,
    "loan_amnt": loan_amnt,
    "loan_int_rate": interest_rate,
    "loan_percent_income": dti,
    "cb_person_default_on_file": default_before,
    "person_home_ownership": home_ownership,
    "loan_intent": loan_intent,
}

df = pd.DataFrame([input_dict])

# One-hot encoding (same as training)
df = pd.get_dummies(df)

# Align columns with model
model_features = model.get_booster().feature_names
X = df.reindex(columns=model_features, fill_value=0)

# Scale numerical features
num_cols = [
    "person_age",
    "person_income",
    "person_emp_length",
    "cb_person_cred_hist_length",
    "loan_amnt",
    "loan_int_rate",
    "loan_percent_income",
]

X[num_cols] = scaler.transform(X[num_cols])


# ------------------------------------
# Predict + SHAP
# ------------------------------------
if st.button("ðŸš€ Predict Default Risk"):

    prob = model.predict_proba(X)[0][1]
    st.subheader(f"Estimated Probability of Default: **{prob*100:.2f}%**")

    # Risk color message
    if prob < 0.15:
        st.success("ðŸŸ¢ Low Risk â€” Client unlikely to default.")
    elif prob < 0.35:
        st.warning("ðŸŸ¡ Medium Risk â€” Some risk present.")
    else:
        st.error("ðŸ”´ High Risk â€” High likelihood of default.")

    # ----------------------------------------------------
    # SHAP Summary â€” Top Contributing Factors (Bar Plot)
    # ----------------------------------------------------
    st.subheader("ðŸ” SHAP Feature Impact (Top Predictors)")

    explainer = shap.TreeExplainer(model)
    shap_values = explainer.shap_values(X)

    if isinstance(shap_values, list):
        shap_row = shap_values[1][0]
    else:
        shap_row = shap_values[0]

    shap_df = pd.DataFrame({
        "feature": X.columns,
        "shap": shap_row,
        "abs_val": np.abs(shap_row)
    }).sort_values("abs_val", ascending=False)

    shap_df["pretty"] = shap_df["feature"].apply(prettify_feature_name)

    # Take top 10 features
    top_df = shap_df.head(10)

    # Plot
    plt.figure(figsize=(8, 6))
    ax = sns.barplot(
        data=top_df,
        x="shap",
        y="pretty",
        color="#93c5fd",
    )

    # Color bars (red = increases risk, blue = decreases risk)
    for i, val in enumerate(top_df["shap"]):
        ax.patches[i].set_color("#ef4444" if val > 0 else "#3b82f6")

    plt.axvline(0, color="black", linestyle="--")
    plt.xlabel("SHAP Impact (positive = higher risk)")
    plt.ylabel("")
    plt.title("Top Features Influencing Default Risk")

    st.pyplot(plt)
