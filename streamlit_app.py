# -*- coding: utf-8 -*-
"""streamlit_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1M0gY5vmJM_Od6sB1JYtAb_ZEl99MF4uz
"""

import time

import joblib
import numpy as np
import pandas as pd
import plotly.graph_objects as go
import shap
import streamlit as st
import matplotlib.pyplot as plt

# -----------------------------------------------------------
# PAGE CONFIG
# -----------------------------------------------------------
st.set_page_config(
    page_title="Credit Risk Prediction",
    page_icon="üí≥",
    layout="wide",
)

# -----------------------------------------------------------
# LOAD MODEL + SCALER + SHAP EXPLAINER
# -----------------------------------------------------------
@st.cache_resource
def load_objects():
    model = joblib.load("xgboost_credit_model.pkl")
    scaler = joblib.load("scaler.pkl")
    explainer = shap.TreeExplainer(model)
    return model, scaler, explainer

model, scaler, explainer = load_objects()
SCALER_COLS = scaler.feature_names_in_  # columns scaled in training

# -----------------------------------------------------------
# SIMPLE DARK STYLE
# -----------------------------------------------------------
st.markdown("""
<style>
body {
    background-color: #111827;
    color: #F3F4F6;
}

/* Titles */
h1, h2, h3, h4 {
    color: #F3F4F6 !important;
    font-weight: 700 !important;
}

/* Card container */
.block {
    background-color: #1F2937;
    padding: 18px 22px;
    border-radius: 12px;
    border: 1px solid #374151;
    margin-bottom: 16px;
}

/* Inputs */
.stNumberInput input, .stSelectbox div[data-baseweb="select"] {
    background-color: #F9FAFB !important;
    color: #111827 !important;
}

/* Predict button */
.stButton>button {
    width: 100%;
    border-radius: 10px;
    background-color: #2563EB;
    color: white;
    height: 3em;
    font-size: 1.05em;
}
</style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------
# SIDEBAR
# -----------------------------------------------------------
st.sidebar.title("‚ÑπÔ∏è About this App")
st.sidebar.write("""
This app uses a trained **XGBoost** model to estimate  
the probability that a client will **default** on a loan.

‚Ä¢ Trained on a credit risk dataset  
‚Ä¢ Includes preprocessing (encoding + scaling)  
‚Ä¢ Outputs probability + risk level + explanation
""")

st.sidebar.markdown("---")
st.sidebar.write("**Tips:**")
st.sidebar.write("- Higher `loan_percent_income` ‚Üí more risk")
st.sidebar.write("- Previous default history strongly increases risk")
st.sidebar.write("- Loan grade, interest rate & DTI are key drivers")

# -----------------------------------------------------------
# HEADER
# -----------------------------------------------------------
st.markdown("<h1>üí≥ Credit Risk Prediction</h1>", unsafe_allow_html=True)
st.write("Fill in the client and loan information below to estimate default risk.")

st.markdown("---")

# -----------------------------------------------------------
# FORM INPUTS
# -----------------------------------------------------------
with st.form("prediction_form"):

    col_client, col_loan = st.columns(2)

    # ---------- CLIENT INFO ----------
    with col_client:
        st.markdown("<div class='block'><h3>üë§ Client Information</h3>", unsafe_allow_html=True)

        person_age = st.number_input("Age", 18, 100, 30)
        person_income = st.number_input("Annual Income ($)", 0, 5_000_000, 50_000)
        person_emp_length = st.number_input("Employment Length (years)", 0, 50, 5)
        cb_person_cred_hist_length = st.number_input("Credit History Length (years)", 0, 50, 10)

        person_home_ownership = st.selectbox(
            "Home Ownership",
            ["RENT", "OWN", "MORTGAGE", "OTHER"]
        )

        cb_person_default_on_file = st.selectbox(
            "Has Defaulted Before?",
            ["N", "Y"]  # default: No
        )

        st.markdown("</div>", unsafe_allow_html=True)

    # ---------- LOAN INFO ----------
    with col_loan:
        st.markdown("<div class='block'><h3>üí∞ Loan Information</h3>", unsafe_allow_html=True)

        loan_intent = st.selectbox(
            "Loan Intent",
            ["PERSONAL", "EDUCATION", "MEDICAL", "VENTURE", "HOMEIMPROVEMENT", "DEBTCONSOLIDATION"]
        )

        loan_grade = st.selectbox("Loan Grade", ["A", "B", "C", "D", "E", "F", "G"])
        loan_amnt = st.number_input("Loan Amount ($)", 500, 40_000, 10_000)
        loan_int_rate = st.number_input("Interest Rate (%)", 0.0, 40.0, 10.0)
        loan_percent_income = st.number_input("Loan Percent Income (Loan / Income)", 0.0, 1.0, 0.20)

        st.markdown("</div>", unsafe_allow_html=True)

    submitted = st.form_submit_button("üîç Predict Default Risk")

# -----------------------------------------------------------
# PREPROCESSING FUNCTION
# -----------------------------------------------------------
def preprocess_single_sample():
    df = pd.DataFrame([{
        "person_age": person_age,
        "person_income": person_income,
        "person_emp_length": person_emp_length,
        "loan_grade": loan_grade,
        "loan_amnt": loan_amnt,
        "loan_int_rate": loan_int_rate,
        "loan_percent_income": loan_percent_income,
        "cb_person_default_on_file": cb_person_default_on_file,
        "cb_person_cred_hist_length": cb_person_cred_hist_length,
        "person_home_ownership": person_home_ownership,
        "loan_intent": loan_intent,
    }])

    # Binary encoding
    df["cb_person_default_on_file"] = df["cb_person_default_on_file"].map({"Y": 1, "N": 0})

    # Ordinal encoding for grade
    grade_map = {"A": 1, "B": 2, "C": 3, "D": 4, "E": 5, "F": 6, "G": 7}
    df["loan_grade"] = df["loan_grade"].map(grade_map)

    # One-hot encode categorical vars
    df = pd.get_dummies(df)

    # Align with model features
    model_features = model.get_booster().feature_names
    for col in model_features:
        if col not in df:
            df[col] = 0
    df = df[model_features]

    # Scale numeric columns
    df[SCALER_COLS] = scaler.transform(df[SCALER_COLS])

    return df

# -----------------------------------------------------------
# GAUGE FIGURE
# -----------------------------------------------------------
def build_gauge(probability: float):
    """probability in [0,1]"""
    value = probability * 100

    fig = go.Figure(
        go.Indicator(
            mode="gauge+number",
            value=value,
            number={'suffix': '%'},
            gauge={
                'axis': {'range': [0, 100]},
                'bar': {'color': "#2563EB"},
                'steps': [
                    {'range': [0, 15], 'color': "#16a34a"},
                    {'range': [15, 35], 'color': "#facc15"},
                    {'range': [35, 100], 'color': "#ef4444"},
                ],
            },
        )
    )
    fig.update_layout(margin=dict(t=10, b=10, l=10, r=10))
    return fig

# -----------------------------------------------------------
# MAIN PREDICTION
# -----------------------------------------------------------
if submitted:
    # Small animation
    with st.spinner("Calculating risk..."):
        progress = st.progress(0)
        for i in range(0, 101, 20):
            time.sleep(0.05)
            progress.progress(i)

        X_single = preprocess_single_sample()
        prob_default = model.predict_proba(X_single)[0, 1]
        progress.empty()

    # Risk label
    if prob_default < 0.15:
        risk_label = "üü¢ Low Risk"
    elif prob_default < 0.35:
        risk_label = "üü° Medium Risk"
    else:
        risk_label = "üî¥ High Risk"

    st.markdown("<div class='block'>", unsafe_allow_html=True)
    st.markdown("### üìä Prediction Result")

    col_res, col_gauge = st.columns([1.4, 1])

    with col_res:
        st.write(f"**Estimated Default Probability:** `{prob_default*100:.2f}%`")
        st.write(f"**Risk Level:** {risk_label}")
        st.write("""
        **Risk Scale**  
        ‚Ä¢ < 15% ‚Üí Low risk  
        ‚Ä¢ 15‚Äì35% ‚Üí Medium risk  
        ‚Ä¢ > 35% ‚Üí High risk  
        """)

    with col_gauge:
        st.plotly_chart(build_gauge(prob_default), use_container_width=True)

    st.markdown("</div>", unsafe_allow_html=True)

    # -------------------------------------------------------
    # SHAP EXPLANATION
    # -------------------------------------------------------
    st.markdown("<div class='block'>", unsafe_allow_html=True)
    st.markdown("### üîç Why this prediction? (SHAP explanation)")

    shap_values = explainer.shap_values(X_single)

    # XGBoost + SHAP returns list for multi-class; we need the "default" class
    if isinstance(shap_values, list):
        # class 1 = default
        shap_row = shap_values[1][0]
    else:
        shap_row = shap_values[0]

    contrib = pd.Series(shap_row, index=X_single.columns)
    contrib = contrib.reindex(contrib.abs().sort_values(ascending=False).index)

    top_features = contrib.iloc[:6]

    st.write("Positive SHAP value ‚Üí pushes **toward default**. Negative ‚Üí pushes **away from default**.")

    fig, ax = plt.subplots()
    top_features[::-1].plot(kind="barh", ax=ax)
    ax.set_xlabel("SHAP value (impact on default probability)")
    ax.set_ylabel("Feature")
    st.pyplot(fig)

    st.markdown("</div>", unsafe_allow_html=True)
