# -*- coding: utf-8 -*-
"""streamlit_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1M0gY5vmJM_Od6sB1JYtAb_ZEl99MF4uz
"""

    
import streamlit as st
import numpy as np
import pandas as pd
import joblib
import shap
import matplotlib.pyplot as plt
import seaborn as sns
import streamlit.components.v1 as components

# ----------------------------
# Load models & preprocessing
# ----------------------------
model = joblib.load("xgboost_credit_model.pkl")
scaler = joblib.load("scaler.pkl")

# ----------------------------
# Feature Name Prettifier
# ----------------------------
def prettify_feature_name(name):
    pretty_map = {
        "person_age": "Age",
        "person_income": "Income",
        "person_emp_length": "Employment Length (yrs)",
        "cb_person_cred_hist_length": "Credit History Length (yrs)",
        "loan_grade": "Loan Grade",
        "loan_amnt": "Loan Amount",
        "loan_int_rate": "Interest Rate",
        "loan_percent_income": "Loan % Income (DTI)",
        "cb_person_default_on_file": "Previous Default",
    }

    if name in pretty_map:
        return pretty_map[name]

    if name.startswith("person_home_ownership_"):
        return "Home Ownership: " + name.split("_")[-1]

    if name.startswith("loan_intent_"):
        return "Loan Intent: " + name.split("_")[-1]

    return name


# ------------------------------------
# Streamlit Page Setup
# ------------------------------------
st.set_page_config(page_title="Credit Risk Prediction", layout="wide")

st.title("ðŸ’³ Credit Risk Prediction App")
st.write("Fill client and loan details to estimate default probability.")

# ------------------------------------
# User Input Forms
# ------------------------------------
col1, col2 = st.columns(2)

with col1:
    st.subheader("Client Information")

    age = st.number_input("Age", 18, 100, 30)
    income = st.number_input("Annual Income ($)", 1000, 500000, 50000)
    emp_length = st.number_input("Employment Length (years)", 0, 60, 5)
    cred_length = st.number_input("Credit History Length (years)", 0, 40, 10)
    home_ownership = st.selectbox("Home Ownership", ["RENT", "OWN", "MORTGAGE", "OTHER"])
    default_before = st.selectbox("Has Defaulted Before?", ["Y", "N"])

with col2:
    st.subheader("Loan Information")

    loan_intent = st.selectbox(
        "Loan Intent",
        ["PERSONAL", "EDUCATION", "MEDICAL", "VENTURE", "HOMEIMPROVEMENT", "DEBTCONSOLIDATION"],
    )

    loan_grade = st.selectbox("Loan Grade", ["A", "B", "C", "D", "E", "F", "G"])
    loan_amnt = st.number_input("Loan Amount ($)", 500, 50000, 10000)
    interest_rate = st.number_input("Interest Rate (%)", 1.0, 40.0, 10.0)
    dti = st.number_input("Loan Percent Income (DTI)", 0.01, 1.0, 0.20)


# ------------------------------------
# Prepare Input Data
# ------------------------------------
input_dict = {
    "person_age": age,
    "person_income": income,
    "person_emp_length": emp_length,
    "cb_person_cred_hist_length": cred_length,
    "loan_grade": loan_grade,
    "loan_amnt": loan_amnt,
    "loan_int_rate": interest_rate,
    "loan_percent_income": dti,
    "cb_person_default_on_file": default_before,
    "person_home_ownership": home_ownership,
    "loan_intent": loan_intent,
}

df = pd.DataFrame([input_dict])

# One-hot encoding (must match training)
df = pd.get_dummies(df)

# Ensure missing columns are added
model_features = model.get_booster().feature_names
X = df.reindex(columns=model_features, fill_value=0)

# Scale numeric columns
num_cols = [
    "person_age",
    "person_income",
    "person_emp_length",
    "cb_person_cred_hist_length",
    "loan_amnt",
    "loan_int_rate",
    "loan_percent_income",
]
X[num_cols] = scaler.transform(X[num_cols])

# ------------------------------------
# Predict
# ------------------------------------
if st.button("ðŸš€ Predict Default Risk"):
    prob = model.predict_proba(X)[0][1]
    st.subheader(f"Estimated Default Probability: **{prob*100:.2f}%**")

    # Risk label
    if prob < 0.15:
        st.success("ðŸŸ¢ Low Risk â€” Client unlikely to default.")
    elif prob < 0.35:
        st.warning("ðŸŸ¡ Medium Risk â€” Some caution advised.")
    else:
        st.error("ðŸ”´ High Risk â€” High likelihood of default.")

    # ------------------------------------
    # SHAP Explainability
    # ------------------------------------
    st.header("ðŸ” SHAP Explainability â€”
