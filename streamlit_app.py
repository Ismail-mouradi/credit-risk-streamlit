# -*- coding: utf-8 -*-
"""streamlit_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1M0gY5vmJM_Od6sB1JYtAb_ZEl99MF4uz
"""

    
# streamlit_app.py

import joblib
import numpy as np
import pandas as pd
import seaborn as sns
import shap
import matplotlib.pyplot as plt
import plotly.graph_objects as go
import streamlit as st
import streamlit.components.v1 as components

# -----------------------------------------------------------
# PAGE CONFIG
# -----------------------------------------------------------
st.set_page_config(
    page_title="Credit Risk Prediction",
    page_icon="üí≥",
    layout="wide",
)

sns.set_theme(style="whitegrid")

# -----------------------------------------------------------
# LOAD MODEL, SCALER, SHAP EXPLAINER
# -----------------------------------------------------------
@st.cache_resource
def load_objects():
    model = joblib.load("xgboost_credit_model.pkl")
    scaler = joblib.load("scaler.pkl")
    explainer = shap.TreeExplainer(model)
    return model, scaler, explainer

model, scaler, explainer = load_objects()
SCALER_COLS = scaler.feature_names_in_

# -----------------------------------------------------------
# HUMAN-READABLE FEATURE NAMES
# -----------------------------------------------------------
def prettify_feature_name(name: str) -> str:
    base_map = {
        "person_age": "Age",
        "person_income": "Income",
        "person_emp_length": "Employment Length",
        "cb_person_cred_hist_length": "Credit History Length",
        "loan_grade": "Loan Grade",
        "loan_amnt": "Loan Amount",
        "loan_int_rate": "Interest Rate",
        "loan_percent_income": "Loan % Income (DTI)",
        "cb_person_default_on_file": "Previous Default",
    }

    if name in base_map:
        return base_map[name]

    if name.startswith("person_home_ownership_"):
        return "Home Ownership: " + name.split("_")[-1]

    if name.startswith("loan_intent_"):
        return "Loan Intent: " + name.split("_")[-1]

    return name

# -----------------------------------------------------------
# PREPROCESSING
# -----------------------------------------------------------
def preprocess(df_raw: pd.DataFrame) -> pd.DataFrame:
    df = df_raw.copy()

    df["cb_person_default_on_file"] = df["cb_person_default_on_file"].map({"Y": 1, "N": 0})
    grade_map = {"A": 1, "B": 2, "C": 3, "D": 4, "E": 5, "F": 6, "G": 7}
    df["loan_grade"] = df["loan_grade"].map(grade_map)

    df = pd.get_dummies(df)

    model_features = model.get_booster().feature_names
    for col in model_features:
        if col not in df:
            df[col] = 0

    df = df[model_features]

    df[SCALER_COLS] = scaler.transform(df[SCALER_COLS])

    return df

# -----------------------------------------------------------
# GAUGE CHART
# -----------------------------------------------------------
def make_gauge(prob: float):
    fig = go.Figure(
        go.Indicator(
            mode="gauge+number",
            value=prob * 100,
            number={"suffix": "%"},
            gauge={
                "axis": {"range": [0, 100]},
                "steps": [
                    {"range": [0, 15], "color": "#c7f9cc"},
                    {"range": [15, 35], "color": "#fef9c3"},
                    {"range": [35, 100], "color": "#fecaca"},
                ],
                "bar": {"color": "#2563eb"},
            },
        )
    )
    fig.update_layout(height=260, margin=dict(t=30, b=10, l=20, r=20))
    return fig

# -----------------------------------------------------------
# LIGHT THEME CSS
# -----------------------------------------------------------
st.markdown(
    """
<style>
.stApp { background-color: #f7f9fc; }
.block {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    margin-bottom: 18px;
}
.stButton>button {
    width: 100%; border-radius: 8px;
    background-color: #2563eb !important;
    color: white !important;
    height: 3em; font-size: 1.05em;
}
</style>
""",
    unsafe_allow_html=True,
)

# -----------------------------------------------------------
# SIDEBAR
# -----------------------------------------------------------
st.sidebar.title("‚ÑπÔ∏è About this app")
st.sidebar.write(
    """
This app predicts the probability that a client will **default on a loan**.

**Includes:**
- Preprocessing pipeline  
- XGBoost credit-risk model  
- Single and batch prediction  
- SHAP explainability (bar plot)  
"""
)
st.sidebar.markdown("---")
st.sidebar.write("üëâ **DTI**, **Loan Grade**, and **Credit History** are strong predictors.")

# -----------------------------------------------------------
# MAIN UI
# -----------------------------------------------------------
st.title("üí≥ Credit Risk Prediction (XGBoost)")
st.markdown("---")

tab_single, tab_batch = st.tabs(["üîç Single Prediction", "üìÇ Batch Prediction"])

# ===========================================================
# üîç SINGLE PREDICTION TAB
# ===========================================================
with tab_single:

    with st.form("single_form"):
        col1, col2 = st.columns(2)

        with =========== CLIENT INFO ===========
        with col1:
            st.markdown("<div class='block'><h3>üë§ Client Information</h3>", unsafe_allow_html=True)
            age = st.number_input("Age", 18, 100, 30)
            income = st.number_input("Annual Income ($)", 0, 5_000_000, 50_000)
            emp_len = st.number_input("Employment Length (years)", 0, 50, 5)
            cred_hist = st.number_input("Credit History Length (years)", 0, 50, 10)
            home_own = st.selectbox("Home Ownership", ["RENT", "OWN", "MORTGAGE", "OTHER"])
            prev_default = st.selectbox("Has Defaulted Before?", ["N", "Y"])
            st.markdown("</div>", unsafe_allow_html=True)

        =========== LOAN INFO ===========
        with col2:
            st.markdown("<div class='block'><h3>üí∞ Loan Information</h3>", unsafe_allow_html=True)
            loan_intent = st.selectbox(
                "Loan Intent",
                ["PERSONAL", "EDUCATION", "MEDICAL", "VENTURE", "HOMEIMPROVEMENT", "DEBTCONSOLIDATION"],
            )
            loan_grade = st.selectbox("Loan Grade", ["A","B","C","D","E","F","G"])
            loan_amnt = st.number_input("Loan Amount ($)", 500, 50_000, 10_000)
            loan_rate = st.number_input("Interest Rate (%)", 0.0, 40.0, 10.0)
            loan_pct_income = st.number_input("Loan Percent Income (DTI)", 0.0, 1.0, 0.20)
            st.markdown("</div>", unsafe_allow_html=True)

        submitted = st.form_submit_button("üîé Predict Risk")

    if submitted:
        raw = pd.DataFrame([
            {
                "person_age": age,
                "person_income": income,
                "person_emp_length": emp_len,
                "cb_person_cred_hist_length": cred_hist,
                "person_home_ownership": home_own,
                "cb_person_default_on_file": prev_default,
                "loan_intent": loan_intent,
                "loan_grade": loan_grade,
                "loan_amnt": loan_amnt,
                "loan_int_rate": loan_rate,
                "loan_percent_income": loan_pct_income,
            }
        ])

        X = preprocess(raw)
        prob = model.predict_proba(X)[0, 1]

        # ---------------------------------------------------
        # Prediction Output
        # ---------------------------------------------------
        st.markdown("<div class='block'>", unsafe_allow_html=True)
        st.subheader("Prediction Result")

        rc1, rc2 = st.columns([1, 1])
        rc1.write(f"### Default Probability: **{prob*100:.2f}%**")

        if prob < 0.15:
            rc1.success("üü¢ Low Risk")
        elif prob < 0.35:
            rc1.warning("üü° Medium Risk")
        else:
            rc1.error("üî¥ High Risk")

        rc2.plotly_chart(make_gauge(prob), use_container_width=True)

        st.markdown("</div>", unsafe_allow_html=True)

        # ====================================================
        # SHAP EXPLANATION (BAR PLOT ONLY)
        # ====================================================
        st.markdown("<div class='block'>", unsafe_allow_html=True)
        st.subheader("üîç SHAP Explainability ‚Äî Why This Prediction?")

        shap_values = explainer.shap_values(X)
        shap_row = shap_values[1][0] if isinstance(shap_values, list) else shap_values[0]

        shap_df = pd.DataFrame({
            "feature": X.columns,
            "shap": shap_row,
            "abs": np.abs(shap_row),
        }).sort_values("abs", ascending=False)

        shap_df["pretty"] = shap_df["feature"].apply(prettify_feature_name)

        top_df = shap_df.head(10)

        plt.figure(figsize=(8, 5))
        ax = sns.barplot(data=top_df, x="shap", y="pretty", color="#93c5fd")

        for i, v in enumerate(top_df["shap"]):
            ax.patches[i].set_color("#ef4444" if v > 0 else "#3b82f6")

        plt.axvline(0, color="black", linestyle="--")
        plt.xlabel("SHAP Impact (positive = higher risk)")
        plt.ylabel("")
        plt.title("Top Features Influencing Default Risk")
        st.pyplot(plt)

        st.markdown("</div>", unsafe_allow_html=True)

# ===========================================================
# üìÇ BATCH PREDICTION TAB
# ===========================================================
with tab_batch:
    st.markdown("<div class='block'><h3>üìÇ Batch CSV Prediction</h3>", unsafe_allow_html=True)

    uploaded = st.file_uploader("Upload CSV", type=["csv"])

    if uploaded:
        df_input = pd.read_csv(uploaded)
        st.write("Preview:", df_input.head())

        Xb = preprocess(df_input)
        probs = model.predict_proba(Xb)[:, 1]

        df_out = df_input.copy()
        df_out["default_probability"] = probs
        df_out["risk"] = pd.cut(
            probs, bins=[0, 0.15, 0.35, 1], labels=["Low", "Medium", "High"]
        )

        st.write(df_out.head())

        st.download_button(
            "‚¨áÔ∏è Download Results CSV",
            df_out.to_csv(index=False).encode("utf-8"),
            "credit_risk_predictions.csv",
            "text/csv",
        )

